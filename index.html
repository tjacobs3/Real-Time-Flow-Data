<!doctype html>

<html>
  <head>
    <style type="text/css" media="screen">
      html, body {
        margin: 0;
      }
      
      body {
        background: #eee;
      }
      
      #container {
        background: white;
        border: 1px solid #ccc;
        font-family: "Helvetica Neue", Arial, sans-serif;
        margin: 1em auto;
        min-height: 500px;
        padding: 0 1em;
        position: relative;
        width: 950px;
      }
      
      #container .chart_prompt {
        left: 0;
        margin: auto;
        position: absolute;
        right: 0;
        top: 20px;
        width: 300px;
      }
      
      #header {
        border-bottom: 1px solid #999;
      }
      
      .prompt {
        font-style: italic;
        margin: 1em auto;
        padding: 1em;
        text-align: center;
        width: 300px;
      }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/highcharts.js" type="text/javascript"></script>
  </head>
  <body>
    <div id="container">
      <div id="header">
        <h1>Real-time Stream Flow Data</h1>
      </div>
      <div id="content">
        <div id="filter">
          <form>
            <div id="location-time-type">
              <span>
                Location:
                <select name="location" id="location">
                  <option value="U22">U22</option>
                </select>
              </span>
              <span>
                <label for="period">Period</label><input type="text" name="period" value="7" id="period">
              </span>
              <!-- <span id="data-type">
                              Data Type:
                              <input type="radio" name="data-type" value="real" id="data-type-observed"><label for="data-type-real">Observed Data</label>
                              <input type="radio" name="data-type" value="simulated" id="data-type-simulated"><label for="data-type-simulated">Simulated Data</label>
                              <input type="radio" name="data-type" value="both" id="data-type-real" checked="checked"><label for="data-type-both">Both</label>
                            </span> -->
              <span>
                <a id="refresh-button">Refresh</a>
              </span>
            </div>
          </form>
        </div>
        <div id="main-content">
          <div id="elevation"></div>
          <hr />
          <div id="discharge"></div>
        </div>
      </div>
      <div id="footer">
      </div>
    </div>
    
    <script type="text/javascript" charset="utf-8">
      var rsfd = rsfd || {};
      rsfd.ui = rsfd.ui || {};
      rsfd.data = rsfd.data || {};
      rsfd.chart = rsfd.chart || {};
      rsfd.controller = rsfd.controller || {};
      
      rsfd.ui.showLoading = function () {
        $('#main-content>div').hide();
        $('#main-content #loading').show();
      }
      
      rsfd.ui.showSelectPrompt = function () {
        $('#main-content>div').hide();
        $('#main-content #select-prompt').show();
      }
      
      rsfd.ui.getLocation = function () {
        return $("#location option:selected").val()
      }
      
      rsfd.ui.getPeriod = function () {
        return parseInt($("#period").val());
      }
      
      rsfd.ui.getDataType = function () {
        return "both";
        return $("#data-type input[name='data-type']:checked").val();
      }
      
      rsfd.ui.getAllParameter = function () {
        return {
          location: rsfd.ui.getLocation(),
          period: rsfd.ui.getPeriod(),
          data_type: rsfd.ui.getDataType()
        }
      }
      
      rsfd.data.getRealData = function (p, callbackFunc) {
        if (typeof callbackFunc !== 'function')
          return false;
         
        $.getJSON('get_plot_data.php', p, callbackFunc);
        
        return true;
      };
      
      rsfd.data.getSimulatedData = function (p, simfile, callbackFunc) {
        if (typeof callbackFunc !== 'function')
          return false;
          
        p2 = {};
        
        for (var prop in p) {
          p2[prop] = p[prop];
        }
        
        if (typeof simfile === "string" && simfile !== '')
          p2.simLocation = simfile;
          
        $.getJSON('get_simulation_data.php', p2, callbackFunc);
        
        return true;
      }
      
      rsfd.chart.Chart = function (container, title, location, id) {
        if (typeof id !== 'string') {
          id = container + '_chart';
        }
        
        this.container = container;
        this.title = title;
        this.location = location;
        this.id = id;
        this.loading = 0;
        
        this.chart = new Highcharts.Chart({
          chart: {
			      zoomType: 'x',
            renderTo: container
          },
          title: {
            text: this.title
          },
          location: {
            text: this.location
          },
    		  plotOptions: {
      			series: {
      				marker: {
      					enabled: false,
      					states: {
      						hover: {
      							enabled: true
      						}
      					}
      				}
      			}
    		  },
          tooltip: {
            formatter: function () {
              return Highcharts.dateFormat("%b %d, %Y", this.x) + ": " + this.y;
            }
          },
          xAxis: {
            type: 'datetime',
            dateTimeLabelFormats: {

            }
          },
          series: []
        });
        
        this.series = {};
        
        var con = $('#' + this.container);
        var prompt = 
          $('<div></div>')
            .attr('id', id + '_prompt')
            .addClass('chart_prompt')
            .hide()
            .appendTo(con);
      }
      
      rsfd.chart.Chart.prototype.displayData = function (data) {
        for (var type in data.series) { 
          if (type in this.series) {
            this.series[type].remove();
          }
          
          this.series[type] = this.chart.addSeries({
            type: 'spline',
            name: type,
            data: data.series[type],
            pointStart: Date(0)
          });
          
        }
      }
      
      
      rsfd.chart.Chart.prototype.showPrompt = function (id, content) {
        
      }
      
      rsfd.chart.Chart.prototype.hidePrompt = function (id, content) {
        
      }
      
      rsfd.controller.Controller = function () {
        this.charts = {};
      }
      
      rsfd.controller.Controller.prototype.registerChart = function (type, chart) {
        this.charts[type] = chart;
      }
      
      rsfd.controller.Controller.prototype.showData = function() {
        var p = rsfd.ui.getAllParameter();
        
        for (var chart_type in this.charts) {
          var chart = this.charts[chart_type];
          p.chartType = chart_type;
          rsfd.data.getRealData(p, function (c) {
            return function (data) {
              c.displayData(data);
            }
          } (chart));
          
          rsfd.data.getSimulatedData(p, '', function (c) {
            return function (data) {
              c.displayData(data);
            }
          } (chart));

          rsfd.data.getSimulatedData(p, 'ld2g1.2011.wsq', function (c) {
            return function (data) {
              c.displayData(data);
            }
          } (chart));
        }
      }
      
      $(document).ready(function () {
        //rsfd.ui.showSelectPrompt();    
        var elevation_chart = new rsfd.chart.Chart("elevation", rsfd.ui.getLocation() + " Gage Height", rsfd.ui.getLocation());
        var discharge_chart = new rsfd.chart.Chart("discharge", rsfd.ui.getLocation() + " Discharge", rsfd.ui.getLocation());
        controller = new rsfd.controller.Controller();
        controller.registerChart("elevation", elevation_chart);
        controller.registerChart("discharge", discharge_chart);
        controller.showData();
        $('#refresh-button').click(function () {
          controller.showData();
        });
      })
    </script>
  </body>
</html>